<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Call Voice Beta - Final Edition</title>
    
    <style>
        :root {
            --bg-color: #0a0a0f; --surface-color: #16161d;
            --primary-color: #ffffff; --text-color: #e8e8e8;
            --text-muted: #8a8a9e; --glow-color: #00f2ea;
            --red-color: #ff3b5f; --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; background-color: var(--bg-color); }
        body { font-family: var(--font-family); display: flex; justify-content: center; align-items: center; }
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #333;
            border-top-color: var(--glow-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #app-container {
            width: 100%; max-width: 390px; height: 100%; max-height: 844px;
            background-color: var(--surface-color); border-radius: 40px;
            box-shadow: 0 0 100px rgba(0, 242, 234, 0.1); display: flex;
            flex-direction: column; overflow: hidden; position: relative;
            transition: var(--transition);
        }
        .hidden { opacity: 0; pointer-events: none; transform: scale(0.95); }
        .screen {
            display: flex; flex-direction: column; align-items: center;
            justify-content: space-between; text-align: center;
            padding: 60px 30px; height: 100%; width: 100%;
            position: absolute; transition: var(--transition);
        }
        .screen.hidden { opacity: 0; pointer-events: none; }
        .lobby-header .subtitle { color: var(--text-muted); font-weight: 300; }
        .id-display {
            padding: 10px 20px; cursor: pointer; text-align: center;
            border: 1px solid #2a2a30; border-radius: 15px;
            transition: transform 0.2s ease;
        }
        .id-display:active { transform: scale(0.95); }
        .id-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;}
        #your-id { font-size: 1.2rem; color: var(--primary-color); }
        #status-text { color: var(--glow-color); font-size: 0.9rem; min-height: 20px; }
        .call-form { width: 100%; }
        #callee-id-input {
            width: 100%; padding: 15px; border: 1px solid #333; border-radius: 12px;
            background-color: #222; color: var(--primary-color); font-size: 1rem;
            text-align: center; margin-bottom: 20px;
        }
        .btn { border: none; cursor: pointer; transition: var(--transition); }
        .btn-call {
            width: 70px; height: 70px; border-radius: 50%;
            background-color: var(--glow-color); color: var(--bg-color);
            box-shadow: 0 0 25px rgba(0, 242, 234, 0.4);
        }
        .btn-call:disabled { background-color: #444; box-shadow: none; color: #888; }
        .icon { width: 26px; height: 26px; fill: currentColor; }
        .call-header h2 { font-weight: 400; color: var(--primary-color);}
        .call-header p { color: var(--text-muted); }
        .visual-centerpiece {
            position: relative; width: 250px; height: 250px;
            display: flex; justify-content: center; align-items: center;
            margin: auto 0;
        }
        #audio-visualizer { width: 100%; height: 100%; }
        .pulsar-ring {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            border: 1px solid var(--glow-color); border-radius: 50%;
            animation: pulsar 3s ease-out infinite; opacity: 0;
        }
        .pulsar-ring:nth-child(2) { animation-delay: 1s; }
        .pulsar-ring:nth-child(3) { animation-delay: 2s; }
        @keyframes pulsar {
            from { transform: scale(0.5); opacity: 0.7; }
            to { transform: scale(1.5); opacity: 0; }
        }
        .control-btn {
            width: 75px; height: 75px; border-radius: 50%; color: var(--primary-color);
            display: flex; justify-content: center; align-items: center;
        }
        .btn-end-call { background-color: var(--red-color); }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="spinner"></div>
        <p>Final Edition</p>
    </div>

    <div id="app-container" class="hidden">
        <div class="screen" id="lobby-screen">
            <header class="lobby-header">
                <h1 style="color: var(--primary-color);">Call Voice Beta</h1>
                <p class="subtitle">Final Edition</p>
            </header>
            
            <div class="id-display" id="your-id-container" title="Bấm để sao chép ID của bạn">
                <span class="id-label">ID CỦA BẠN</span>
                <h2 id="your-id">...</h2>
            </div>
            
            <div class="call-form">
                <p id="status-text"></p>
                <input type="text" id="callee-id-input" placeholder="Dán ID của người nhận">
                <button class="btn btn-call" id="start-call-btn" disabled aria-label="Bắt đầu gọi">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.976.976 0 0 0-1.01.24l-1.57 1.97c-2.83-1.35-5.25-3.77-6.6-6.6l1.97-1.57a.995.995 0 0 0 .24-1.01c-.36-1.11-.56-2.3-.56-3.53A1 1 0 0 0 7.62 3H4.01A1 1 0 0 0 3 4.01c0 9.39 7.61 17 17 17a1 1 0 0 0 1.01-1V16.38a1 1 0 0 0-1-1z"></path></svg>
                </button>
            </div>
        </div>

        <div class="screen hidden" id="call-screen">
            <div class="call-header">
                <h2 id="call-status-heading">Đang gọi...</h2>
                <p id="callee-id-display"></p>
            </div>
            
            <div class="visual-centerpiece">
                <div class="pulsar-ring"></div>
                <div class="pulsar-ring"></div>
                <div class="pulsar-ring"></div>
                <canvas id="audio-visualizer"></canvas>
            </div>

            <div class="main-controls">
                <button class="btn control-btn btn-end-call" id="end-call-btn" aria-label="Kết thúc cuộc gọi">
                     <svg class="icon" viewBox="0 0 24 24"><path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91"></path></svg>
                </button>
            </div>
        </div>
        
        <audio id="remote-audio" autoplay></audio>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const el = {};
            const ids = ['preloader', 'app-container', 'lobby-screen', 'call-screen', 'your-id', 'your-id-container', 'status-text', 'callee-id-input', 'start-call-btn', 'end-call-btn', 'call-status-heading', 'callee-id-display', 'remote-audio', 'audio-visualizer'];
            ids.forEach(id => el[id.replace(/-(\w)/g, (m, p1) => p1.toUpperCase())] = document.getElementById(id));

            const state = { peer: null, localStream: null, currentCall: null, audioContext: null, analyser: null, animationFrameId: null };

            function updateStatus(text, isError = false) {
                el.statusText.textContent = text;
                el.statusText.style.color = isError ? 'var(--red-color)' : 'var(--glow-color)';
            }

            function showScreen(screen) {
                el.lobbyScreen.classList.toggle('hidden', screen !== 'lobby');
                el.callScreen.classList.toggle('hidden', screen !== 'call');
            }

            function drawVisualizer() {
                state.animationFrameId = requestAnimationFrame(drawVisualizer);
                if (!state.analyser) return;
                const bufferLength = state.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                state.analyser.getByteFrequencyData(dataArray);
                const ctx = el.audioVisualizer.getContext('2d');
                const { width, height } = el.audioVisualizer;
                const centerX = width / 2;
                const centerY = height / 2;
                const radius = Math.min(width, height) / 4;
                ctx.clearRect(0, 0, width, height);
                for (let i = 0; i < bufferLength; i++) {
                    const value = dataArray[i];
                    const percent = value / 255;
                    const barHeight = percent * 60;
                    const angle = (Math.PI * 2 / bufferLength) * i - Math.PI / 2;
                    const startX = centerX + Math.cos(angle) * radius;
                    const startY = centerY + Math.sin(angle) * radius;
                    const endX = centerX + Math.cos(angle) * (radius + barHeight);
                    const endY = centerY + Math.sin(angle) * (radius + barHeight);
                    ctx.strokeStyle = `hsl(178, 100%, ${50 + percent * 50}%)`;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                }
            }

            async function init() {
                try {
                    updateStatus('Đang kết nối máy chủ...');
                    state.peer = new Peer();
                    state.peer.on('open', handlePeerOpen);
                    state.peer.on('call', handleIncomingCall);
                    state.peer.on('error', handlePeerError);
                } catch (error) {
                    updateStatus('Lỗi khởi tạo PeerJS', true);
                    console.error('PeerJS constructor error:', error);
                }
            }

            function handlePeerOpen(id) {
                el.preloader.classList.add('hidden');
                el.appContainer.classList.remove('hidden');
                el.yourId.textContent = id;
                el.startBtn.disabled = false;
                updateStatus('Sẵn sàng!');
            }

            function handlePeerError(err) {
                updateStatus(`Lỗi kết nối: ${err.type}`, true);
                console.error('PeerJS error:', err);
            }

            async function startCall() {
                const calleeId = el.calleeInput.value.trim();
                if (!calleeId) { updateStatus('Vui lòng nhập ID', true); return; }
                
                try {
                    updateStatus(`Đang gọi ${calleeId}...`);
                    const constraints = { audio: { echoCancellation: true, noiseSuppression: true } };
                    state.localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    if (!state.audioContext) state.audioContext = new AudioContext();
                    const source = state.audioContext.createMediaStreamSource(state.localStream);
                    state.analyser = state.audioContext.createAnalyser();
                    source.connect(state.analyser);
                    const call = state.peer.call(calleeId, state.localStream);
                    setupCallHandlers(call);
                } catch (err) {
                    updateStatus('Không thể truy cập micro', true);
                    console.error('getUserMedia error:', err);
                }
            }

            function handleIncomingCall(call) {
                if (!confirm(`Cuộc gọi đến từ ${call.peer}. Chấp nhận?`)) { call.close(); return; }
                
                navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true } })
                    .then(stream => {
                        state.localStream = stream;
                        if (!state.audioContext) state.audioContext = new AudioContext();
                        const source = state.audioContext.createMediaStreamSource(state.localStream);
                        state.analyser = state.audioContext.createAnalyser();
                        source.connect(state.analyser);
                        call.answer(state.localStream);
                        setupCallHandlers(call);
                    }).catch(err => {
                        updateStatus('Không thể truy cập micro', true);
                        console.error('getUserMedia on answer:', err);
                    });
            }

            function setupCallHandlers(call) {
                state.currentCall = call;
                el.callStatus.textContent = 'Đang kết nối...';
                el.calleeDisplay.textContent = call.peer;
                showScreen('call');
                call.on('stream', remoteStream => {
                    el.callStatus.textContent = 'Đã kết nối';
                    el.remoteAudio.srcObject = remoteStream;
                    drawVisualizer();
                });
                call.on('close', endCall);
                call.on('error', () => endCall('Lỗi cuộc gọi'));
            }

            function endCall(message = 'Cuộc gọi kết thúc') {
                if (state.currentCall) { state.currentCall.close(); state.currentCall = null; }
                if (state.localStream) { state.localStream.getTracks().forEach(track => track.stop()); state.localStream = null; }
                if (state.animationFrameId) { cancelAnimationFrame(state.animationFrameId); state.animationFrameId = null; }
                showScreen('lobby');
                updateStatus(message);
            }
            
            el.startBtn.addEventListener('click', startCall);
            el.endBtn.addEventListener('click', () => endCall());
            el.yourIdContainer.addEventListener('click', () => {
                navigator.clipboard.writeText(el.yourId.textContent).then(() => updateStatus('Đã sao chép ID!'));
            });

            init();
        });
    </script>
</body>
</html>
